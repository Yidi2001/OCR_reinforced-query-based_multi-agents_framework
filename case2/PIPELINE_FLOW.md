# Pipeline å®Œæ•´æµç¨‹è¯´æ˜

## ğŸ”„ æ–°çš„æµç¨‹æ¶æ„

```
ç”¨æˆ·è¾“å…¥: å›¾ç‰‡ + Query
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pipeline.py: process_image()                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚  ä¸»æµç¨‹ç¼–æ’                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”‚ Step 1: è°ƒç”¨ orchestrator.run()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Multi-Agent æ‰§è¡Œæµç¨‹                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚  1. Target Detection (æ‰‹å†™/å°åˆ·åˆ†ç±»)                          â”‚
â”‚  2. Task Planning (Phi3.5 è§„åˆ’é¢„å¤„ç†éœ€æ±‚)                     â”‚
â”‚  3. Prompt Generation (ç”Ÿæˆ Agent é“¾)                        â”‚
â”‚  4. Agent Execution:                                          â”‚
â”‚     â€¢ PreprocessingAgent (å¯é€‰)                               â”‚
â”‚     â€¢ LayoutDetectionAgent (å¯é€‰) â† æ£€æµ‹å¸ƒå±€åŒºåŸŸ              â”‚
â”‚     â€¢ OCR Agent (Hand/Printed) â† é€åŒºåŸŸè¯†åˆ«                   â”‚
â”‚                                                               â”‚
â”‚  è¾“å‡º: å®Œæ•´ç»“æœ (åŒ…å«æ‰€æœ‰ Agent è¾“å‡º)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”‚ Step 2: å¸ƒå±€æ•´åˆ (æ–°å¢!)
    â”‚ _integrate_layout_results()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¸ƒå±€æ™ºèƒ½æ•´åˆ (å¦‚æœæœ‰å¤šä¸ªåŒºåŸŸ)                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚  ä½¿ç”¨ merge_layout_blocks_ratio.py:                           â”‚
â”‚                                                               â”‚
â”‚  åŸå§‹OCRè¾“å‡º (å¯èƒ½æœ‰é‡å¤):                                      â”‚
â”‚    åŒºåŸŸ1: "Contact Information"                               â”‚
â”‚    åŒºåŸŸ2: "Contact:"                      â† é‡å¤/éƒ¨åˆ†é‡å       â”‚
â”‚    åŒºåŸŸ3: "John Doe"                                          â”‚
â”‚    åŒºåŸŸ4: "Email: john@example.com"                           â”‚
â”‚    åŒºåŸŸ5: "Contact:"                      â† é‡å¤              â”‚
â”‚    ...                                                        â”‚
â”‚                                                               â”‚
â”‚  æ•´åˆæ­¥éª¤:                                                     â”‚
â”‚  1ï¸âƒ£ åŒºåŸŸå»é‡: åˆ é™¤ IOU>0.9 ä¸”æ–‡æœ¬ç›¸ä¼¼çš„é‡å¤æ¡†                  â”‚
â”‚  2ï¸âƒ£ è¡Œåˆå¹¶: åŒä¸€æ®µè½çš„å¤šè¡Œæ–‡å­—åˆå¹¶                             â”‚
â”‚  3ï¸âƒ£ å—çº§æ•´åˆ: åŸºäºæ ‡é¢˜ç­‰é”šç‚¹åˆå¹¶ç›¸å…³å†…å®¹                        â”‚
â”‚  4ï¸âƒ£ è¶…é›†å»é‡: åˆ é™¤è¢«å…¶ä»–å—åŒ…å«çš„å†—ä½™æ¡†                         â”‚
â”‚  5ï¸âƒ£ è·¨å—å»é‡: åˆ é™¤æ–‡æœ¬è¢«å®Œå…¨è¦†ç›–çš„å°å—                         â”‚
â”‚                                                               â”‚
â”‚  æ•´åˆåè¾“å‡º:                                                   â”‚
â”‚    Block1: {                                                  â”‚
â”‚      "title": "Contact Information",                          â”‚
â”‚      "text": "John Doe\nEmail: john@example.com...",        â”‚
â”‚      "children": [åŒºåŸŸ1, åŒºåŸŸ3, åŒºåŸŸ4],                       â”‚
â”‚      "bbox": [åˆå¹¶åçš„åæ ‡]                                    â”‚
â”‚    }                                                          â”‚
â”‚                                                               â”‚
â”‚  æ•ˆæœ:                                                        â”‚
â”‚    åŸå§‹: å¯èƒ½æœ‰ 50+ ä¸ªåŒºåŸŸ (å¾ˆå¤šé‡å¤)                          â”‚
â”‚    æ•´åˆå: 7-10 ä¸ªè¯­ä¹‰å— (å»é‡ã€ç»“æ„åŒ–)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”‚ Step 3: ç”Ÿæˆæ‘˜è¦
    â”‚ result_summarizer.summarize()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æå–å…³é”®ä¿¡æ¯ (è¯æ®åŒ…)                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚  è¾“å…¥: å®Œæ•´ç»“æœ (å¯èƒ½å‡ ç™¾KB)                                   â”‚
â”‚                                                               â”‚
â”‚  æå–é€»è¾‘:                                                     â”‚
â”‚    if å­˜åœ¨ merged_blocks:                                     â”‚
â”‚      âœ“ ä½¿ç”¨æ•´åˆåçš„å— (å·²å»é‡)                                 â”‚
â”‚      âœ“ æ¯ä¸ªå—åŒ…å«: æ ‡é¢˜ã€æ–‡å­—ã€å­åŒºåŸŸæ•°é‡                       â”‚
â”‚    else:                                                      â”‚
â”‚      ä½¿ç”¨åŸå§‹ boxes                                            â”‚
â”‚                                                               â”‚
â”‚  è¾“å‡º:                                                        â”‚
â”‚  â€¢ summary.json (ç²¾ç®€ç»“æ„åŒ–æ•°æ®)                               â”‚
â”‚  â€¢ prompt.txt (æ ¼å¼åŒ–æç¤ºæ–‡æœ¬)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”‚ Step 4: ä¸»æ¨¡å‹è£å†³ (å¯é€‰)
    â”‚ phi_refiner.refine()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phi3.5 åŸºäºè¯æ®åŒ…é‡æ–°ç†è§£                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚  è¾“å…¥:                                                        â”‚
â”‚    1. åŸå§‹å›¾ç‰‡                                                â”‚
â”‚    2. OCRè¯æ®åŒ… (prompt.txt)                                  â”‚
â”‚    3. ç”¨æˆ· Query                                              â”‚
â”‚                                                               â”‚
â”‚  Prompt æ„å»º:                                                 â”‚
â”‚    "è¿™æ˜¯ä¸“ä¸šOCRç³»ç»Ÿçš„è¯†åˆ«ç»“æœï¼ˆå·²æ•´åˆå»é‡ï¼‰:                     â”‚
â”‚     [è¯æ®åŒ…å†…å®¹]                                               â”‚
â”‚     è¯·ä½ æŸ¥çœ‹åŸå›¾ï¼Œå‚è€ƒè¿™äº›è¯æ®ï¼Œ                                 â”‚
â”‚     é‡æ–°è¯†åˆ«å¹¶å›ç­”ç”¨æˆ·é—®é¢˜ã€‚"                                    â”‚
â”‚                                                               â”‚
â”‚  Phi3.5 æ¨ç†:                                                 â”‚
â”‚    â€¢ çœ‹åŸå›¾ (è§†è§‰ç†è§£)                                         â”‚
â”‚    â€¢ å‚è€ƒè¯æ®åŒ… (OCRè¾…åŠ©)                                      â”‚
â”‚    â€¢ çº é”™ã€è¡¥å……ã€è£å†³                                          â”‚
â”‚                                                               â”‚
â”‚  è¾“å‡º: refined_response (æœ€ç»ˆç­”æ¡ˆ)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. **è‡ªåŠ¨å¸ƒå±€æ•´åˆ** (æ–°å¢)
- **è§¦å‘æ¡ä»¶**: æ£€æµ‹åˆ°ä½¿ç”¨äº† LayoutDetectionAgent
- **åŠŸèƒ½**: 
  - åˆ é™¤é‡å¤çš„æ£€æµ‹æ¡†
  - åˆå¹¶åŒä¸€æ®µè½çš„å¤šè¡Œæ–‡å­—
  - åŸºäºè¯­ä¹‰å—æ•´åˆç›¸å…³å†…å®¹
  - å¤§å¹…å‡å°‘å†—ä½™ä¿¡æ¯

### 2. **æ™ºèƒ½è¯æ®æå–**
- **ä¼˜å…ˆçº§**: æ•´åˆåçš„å— > åŸå§‹åŒºåŸŸ
- **æ ¼å¼åŒ–**: 
  ```
  ã€åŒºåŸŸ 1ã€‘
    ç±»å‹: text, paragraph_title
    æ ‡é¢˜: Contact Information
    åŒ…å«å­åŒºåŸŸ: 3
    è¯†åˆ«æ–‡å­—:
      John Doe
      Email: john@example.com
      Phone: +1-234-567-8900
  ```

### 3. **token ä¼˜åŒ–**
- **åŸå§‹OCR**: 50ä¸ªåŒºåŸŸ Ã— å¹³å‡100å­— = 5000 tokens
- **æ•´åˆå**: 7ä¸ªå— Ã— å¹³å‡200å­— = 1400 tokens
- **èŠ‚çœ**: çº¦ 70% çš„ token

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

```python
from case2.pipeline import process_image

# ç®€å•ä½¿ç”¨
result = process_image(
    image_path="test.png",
    query="è¯†åˆ«å›¾ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—",
    output_path="output/result.json"
)

# è¾“å‡ºæ–‡ä»¶:
# - output/result.json         # å®Œæ•´ç»“æœ
# - output/result_summary.json # æ‘˜è¦ï¼ˆæ•´åˆåï¼‰
# - output/result_prompt.txt   # è¯æ®åŒ…æ–‡æœ¬
```

## ğŸ” æ•´åˆæ•ˆæœç¤ºä¾‹

### åŸå§‹ OCR è¾“å‡º (æœªæ•´åˆ)
```json
{
  "regions": [
    {"id": 1, "text": "Contact"},
    {"id": 2, "text": "Contact Information"},  // é‡å¤
    {"id": 3, "text": "John"},
    {"id": 4, "text": "Doe"},                  // åº”è¯¥åˆå¹¶
    {"id": 5, "text": "Email:"},
    {"id": 6, "text": "john@example.com"},
    {"id": 7, "text": "Contact"},              // é‡å¤
    ...
  ]
}
```

### æ•´åˆåè¾“å‡º
```json
{
  "merged_blocks": [
    {
      "block_id": 1,
      "title": "Contact Information",
      "text": "John Doe\nEmail: john@example.com\nPhone: +1-234-567-8900",
      "children_count": 5,
      "bbox": [x1, y1, x2, y2]
    }
  ],
  "merge_stats": {
    "original_regions": 50,
    "merged_blocks": 7
  }
}
```

## ğŸ¨ é€‚ç”¨åœºæ™¯

### âœ… æœ€é€‚åˆæ•´åˆçš„åœºæ™¯
1. **å¤šæ æ–‡æ¡£** - æŠ¥çº¸ã€æ‚å¿—ã€è®ºæ–‡
2. **è¡¨æ ¼å¯†é›†** - è´¢åŠ¡æŠ¥å‘Šã€æ•°æ®è¡¨
3. **å¤æ‚å¸ƒå±€** - PPTã€æµ·æŠ¥ã€å®£ä¼ å†Œ
4. **æ ‡é¢˜+æ­£æ–‡** - ä¹¦ç±ã€æ–‡ç« ã€æŠ¥å‘Š

### âš ï¸ æ•´åˆæ•ˆæœæœ‰é™çš„åœºæ™¯
1. **å•è¡Œæ–‡å­—** - æœ¬èº«å°±æ²¡æœ‰é‡å¤
2. **è‰ºæœ¯å­—ä½“** - å¸ƒå±€æ£€æµ‹å¯èƒ½ä¸å‡†
3. **æ‰‹å†™ä½“** - OCRæœ¬èº«å‡†ç¡®ç‡å½±å“æ•´åˆæ•ˆæœ

## ğŸš€ æ€§èƒ½å½±å“

| æŒ‡æ ‡ | åŸå§‹ | æ•´åˆå | æå‡ |
|------|------|-------|------|
| åŒºåŸŸæ•° | 50+ | 7-10 | 5-7x |
| Tokenæ•° | 5000+ | 1500 | 3-4x |
| ä¿¡æ¯å¯†åº¦ | ä½ (é‡å¤å¤š) | é«˜ (å»é‡) | â†‘â†‘ |
| å¯è¯»æ€§ | å·® (ç¢ç‰‡åŒ–) | å¥½ (ç»“æ„åŒ–) | â†‘â†‘ |
| å¤„ç†æ—¶é—´ | +0.5s | +0.5s | æŒå¹³ |

## ğŸ’¡ åç»­ä¼˜åŒ–æ–¹å‘

1. **è‡ªé€‚åº”é˜ˆå€¼** - æ ¹æ®æ–‡æ¡£ç±»å‹è°ƒæ•´æ•´åˆå‚æ•°
2. **è¯­ä¹‰åˆ†å—** - ä½¿ç”¨ embedding åˆ¤æ–­å†…å®¹ç›¸å…³æ€§
3. **è¡¨æ ¼è¯†åˆ«** - ä¸“é—¨å¤„ç†è¡¨æ ¼åŒºåŸŸçš„æ•´åˆ
4. **å…¬å¼å¤„ç†** - LaTeX å…¬å¼çš„ç‰¹æ®Šæ•´åˆè§„åˆ™



