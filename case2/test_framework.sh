#!/bin/bash
# Case2 æ¡†æ¶å¿«é€Ÿæµ‹è¯•è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  Case2 Multi-Agent Framework æµ‹è¯•è„šæœ¬"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
cd "$(dirname "$0")/.."
echo "ğŸ“ å·¥ä½œç›®å½•: $(pwd)"
echo ""

# æ£€æŸ¥ conda ç¯å¢ƒ
if [[ "$CONDA_DEFAULT_ENV" != "phi" ]] && [[ "$CONDA_DEFAULT_ENV" != "base" ]]; then
    echo "âš ï¸  è­¦å‘Š: å½“å‰ä¸åœ¨ phi æˆ– base ç¯å¢ƒä¸­"
    echo "   å»ºè®®è¿è¡Œ: conda activate phi"
    echo ""
fi

# æ£€æŸ¥å¿…è¦æ–‡ä»¶
echo "ğŸ” æ£€æŸ¥å¿…è¦æ–‡ä»¶..."
FILES_TO_CHECK=(
    "models/phi-3_5_vision/config.json"
    "checkpoints/printed_vs_hand_best.pth"
    "case2/run.py"
    "case2/orchestrator.py"
)

MISSING_FILES=()
for file in "${FILES_TO_CHECK[@]}"; do
    if [[ ! -f "$file" ]]; then
        MISSING_FILES+=("$file")
    fi
done

if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
    echo "âŒ ç¼ºå°‘ä»¥ä¸‹æ–‡ä»¶:"
    for file in "${MISSING_FILES[@]}"; do
        echo "   - $file"
    done
    echo ""
    echo "è¯·ç¡®ä¿æ¨¡å‹æ–‡ä»¶å·²æ­£ç¡®æ”¾ç½®"
    exit 1
fi

echo "âœ“ æ‰€æœ‰å¿…è¦æ–‡ä»¶å°±ç»ª"
echo ""

# æŸ¥æ‰¾æµ‹è¯•å›¾ç‰‡
echo "ğŸ” æŸ¥æ‰¾æµ‹è¯•å›¾ç‰‡..."

# å¯èƒ½çš„æµ‹è¯•å›¾ç‰‡ä½ç½®
TEST_IMAGE=""
POSSIBLE_IMAGES=(
    "OCRBench_Images/HME100k/000000.png"
    "OCRBench_Images/IC15_1811/imgs/000000229.jpg"
    "case1/test_images/sample.jpg"
)

for img in "${POSSIBLE_IMAGES[@]}"; do
    if [[ -f "$img" ]]; then
        TEST_IMAGE="$img"
        break
    fi
done

if [[ -z "$TEST_IMAGE" ]]; then
    echo "âš ï¸  æœªæ‰¾åˆ°æµ‹è¯•å›¾ç‰‡ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®šå›¾ç‰‡è·¯å¾„:"
    echo "   bash case2/test_framework.sh <image_path>"
    echo ""
    echo "æˆ–è€…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:"
    echo "   python case2/run.py --image <your_image_path>"
    exit 1
fi

echo "âœ“ ä½¿ç”¨æµ‹è¯•å›¾ç‰‡: $TEST_IMAGE"
echo ""

# è¿è¡Œæµ‹è¯•
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  å¼€å§‹æµ‹è¯• Case2 æ¡†æ¶"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# åˆ›å»ºè¾“å‡ºç›®å½•
mkdir -p case2_output

# æµ‹è¯• 1: åŸºç¡€æµ‹è¯•ï¼ˆé»˜è®¤ queryï¼‰
echo "ğŸ“‹ æµ‹è¯• 1: åŸºç¡€æµ‹è¯•ï¼ˆé»˜è®¤ queryï¼‰"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
python case2/run.py \
    --image "$TEST_IMAGE" \
    --output case2_output/test_basic.json

echo ""
echo "âœ“ æµ‹è¯• 1 å®Œæˆ"
echo "  è¾“å‡ºæ–‡ä»¶: case2_output/test_basic.json"
echo ""

# æµ‹è¯• 2: è‡ªå®šä¹‰ query
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ“‹ æµ‹è¯• 2: è‡ªå®šä¹‰ query"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
python case2/run.py \
    --image "$TEST_IMAGE" \
    --query "æå–å›¾ç‰‡ä¸­çš„æ‰€æœ‰æ•°å­—å’Œç¬¦å·" \
    --output case2_output/test_custom_query.json

echo ""
echo "âœ“ æµ‹è¯• 2 å®Œæˆ"
echo "  è¾“å‡ºæ–‡ä»¶: case2_output/test_custom_query.json"
echo ""

# æ˜¾ç¤ºç»“æœæ‘˜è¦
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  æµ‹è¯•å®Œæˆï¼ç»“æœæ‘˜è¦"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if command -v jq &> /dev/null; then
    echo "ğŸ“Š æµ‹è¯• 1 ç»“æœ:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    jq '.execution_plan.agents[] | "  \(.order). \(.name)"' -r case2_output/test_basic.json
    echo ""
    
    echo "ğŸ“Š æµ‹è¯• 2 ç»“æœ:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    jq '.execution_plan.agents[] | "  \(.order). \(.name)"' -r case2_output/test_custom_query.json
    echo ""
else
    echo "ğŸ’¡ æç¤º: å®‰è£… jq å¯ä»¥æŸ¥çœ‹æ›´ç¾è§‚çš„ JSON è¾“å‡º"
    echo "   sudo apt install jq"
    echo ""
fi

echo "âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
echo ""
echo "ğŸ“ è¾“å‡ºæ–‡ä»¶ä½ç½®:"
echo "   - case2_output/test_basic.json"
echo "   - case2_output/test_custom_query.json"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ä¸‹ä¸€æ­¥å»ºè®®"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "1. æŸ¥çœ‹ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’:"
echo "   cat case2_output/test_basic.json | jq ."
echo ""
echo "2. æµ‹è¯•å…¶ä»–å›¾ç‰‡:"
echo "   python case2/run.py --image <your_image> --query <your_query>"
echo ""
echo "3. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£:"
echo "   cat case2/README.md"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

